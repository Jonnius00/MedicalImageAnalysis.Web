@page
@model MedicalImageAnalysis.Web.Pages.UploadModel
@{
    ViewData["Title"] = "Upload Medical Image";
}

<h2>Upload Medical Image</h2>

<form method="post" enctype="multipart/form-data">
  <input type="file" asp-for="UploadedFile" accept=".dcm,.png,.jpg,.jpeg,.nii" />
  <button type="submit">Upload</button>
</form>

@* PREVIEW *@
@if (Model.DisplayImageUrl != null) 
{
  <h3>Image Processing Results</h3>
  
  <div class="image-grid">
    <!-- Original Image -->
    <div class="image-card">
      <div class="image-header">
        <h4>Original Image</h4>
      </div>
      <div class="image-container">
        <img src="@Model.DisplayImageUrl" class="grid-image" />
      </div>
      @if (Model.NumberOfFrames > 1)
      {
        <div class="image-info">
          Multi-frame DICOM: @Model.NumberOfFrames frames
        </div>
      }
    </div>
    
    <!-- Otsu Result -->
    @if (Model.OtsuImageUrl != null)
    {
      <div class="image-card">
        <div class="image-header">
          <h4>Otsu Thresholding</h4>
        </div>
        <div class="image-container">
          <img src="@Model.OtsuImageUrl" class="grid-image" />
        </div>
      </div>
    }
    
    <!-- K-means Result -->
    @if (Model.KMeansImageUrl != null)
    {
      <div class="image-card">
        <div class="image-header">
          <h4>K-means (K=@Model.KMeans_K)</h4>
        </div>
        <div class="image-container">
          <img src="@Model.KMeansImageUrl" class="grid-image" />
        </div>
      </div>
    }
    
    <!-- PCA Result -->
    @if (Model.PCAImageUrl != null)
    {
      <div class="image-card">
        <div class="image-header">
          <h4>PCA (@Model.PCAComponents components)</h4>
        </div>
        <div class="image-container">
          <img src="@Model.PCAImageUrl" class="grid-image" />
        </div>
        @if (Model.ExplainedVarianceRatios != null && Model.ExplainedVarianceRatios.Length > 0)
        {
          <div class="image-info">
            Variance: @((Model.ExplainedVarianceRatios.Take(Model.PCAComponents).Sum() * 100).ToString("F2"))%
          </div>
        }
      </div>
    }
    
    <!-- Region Growing Result -->
    @if (Model.RegionGrowingImageUrl != null)
    {
      <div class="image-card">
        <div class="image-header">
          <h4>Region Growing (Tolerance=@Model.RegionGrowingTolerance)</h4>
        </div>
        <div class="image-container">
          <img src="@Model.RegionGrowingImageUrl" class="grid-image" />
        </div>
      </div>
    }
    
    <!-- Watershed Result -->
    @if (Model.WatershedImageUrl != null)
    {
      <div class="image-card">
        <div class="image-header">
          <h4>Watershed</h4>
        </div>
        <div class="image-container">
          <img src="@Model.WatershedImageUrl" class="grid-image" />
        </div>
      </div>
    }
    
    <!-- Empty placeholders for grid consistency -->
    @for (int i = 0; i < 9 - 1 - (Model.OtsuImageUrl != null ? 1 : 0) - (Model.KMeansImageUrl != null ? 1 : 0) - (Model.PCAImageUrl != null ? 1 : 0) - (Model.RegionGrowingImageUrl != null ? 1 : 0) - (Model.WatershedImageUrl != null ? 1 : 0); i++)
    {
      <div class="image-card empty-card">
        <div class="image-header">
          <h4>&nbsp;</h4>
        </div>
        <div class="image-container">
          <!-- Empty slot -->
        </div>
      </div>
    }
  </div>
  
  <!-- Buttons to apply algoithms -->
  <div style="margin-top: 20px;">
    <form method="post" asp-page-handler="ApplyOtsu" style="display: inline-block; margin-right: 10px;">
        <input type="hidden" asp-for="DisplayImageUrl" />
        <input type="hidden" asp-for="KMeans_K" />
        <input type="hidden" asp-for="PCAComponents" />
        <input type="hidden" asp-for="NumberOfFrames" />
        <input type="hidden" asp-for="OtsuImageUrl" />
        <input type="hidden" asp-for="KMeansImageUrl" />
        <input type="hidden" asp-for="PCAImageUrl" />
        <input type="hidden" asp-for="RegionGrowingImageUrl" />
        <input type="hidden" asp-for="WatershedImageUrl" />
        <button type="submit">Apply Otsu Thresholding</button>
    </form>
    
    <form method="post" asp-page-handler="ApplyKMeans" style="display: inline-block; margin-right: 10px;">
        <input type="hidden" asp-for="DisplayImageUrl" />
        <input type="hidden" asp-for="PCAComponents" />
        <input type="hidden" asp-for="NumberOfFrames" />
        <input type="hidden" asp-for="OtsuImageUrl" />
        <input type="hidden" asp-for="KMeansImageUrl" />
        <input type="hidden" asp-for="PCAImageUrl" />
        <input type="hidden" asp-for="RegionGrowingImageUrl" />
        <input type="hidden" asp-for="WatershedImageUrl" />
        <label for="KMeans_K">Clusters (K):</label>
        <input asp-for="KMeans_K" type="number" min="2" max="10" style="width: 60px;" />
        <button type="submit">Apply K-means</button>
    </form>
    
    <form method="post" asp-page-handler="ApplyPCA" style="display: inline-block; margin-right: 10px;">
        <input type="hidden" asp-for="DisplayImageUrl" />
        <input type="hidden" asp-for="KMeans_K" />
        <input type="hidden" asp-for="NumberOfFrames" />
        <input type="hidden" asp-for="OtsuImageUrl" />
        <input type="hidden" asp-for="KMeansImageUrl" />
        <input type="hidden" asp-for="PCAImageUrl" />
        <input type="hidden" asp-for="RegionGrowingImageUrl" />
        <input type="hidden" asp-for="WatershedImageUrl" />
        <label for="PCAComponents">PCA Components:</label>
        <input asp-for="PCAComponents" type="number" min="1" max="10" style="width: 60px;" />
        <button type="submit">Apply PCA</button>
    </form>
    
    <form method="post" asp-page-handler="ApplyRegionGrowing" style="display: inline-block;">
        <input type="hidden" asp-for="DisplayImageUrl" />
        <input type="hidden" asp-for="KMeans_K" />
        <input type="hidden" asp-for="PCAComponents" />
        <input type="hidden" asp-for="NumberOfFrames" />
        <input type="hidden" asp-for="OtsuImageUrl" />
        <input type="hidden" asp-for="KMeansImageUrl" />
        <input type="hidden" asp-for="PCAImageUrl" />
        <input type="hidden" asp-for="RegionGrowingImageUrl" />
        <input type="hidden" asp-for="WatershedImageUrl" />
        <label for="RegionGrowingTolerance">Tolerance:</label>
        <input asp-for="RegionGrowingTolerance" type="number" min="0" max="255" style="width: 60px;" />
        <button type="submit">Apply Region Growing</button>
    </form>
    
    <form method="post" asp-page-handler="ApplyWatershed" style="display: inline-block;">
        <input type="hidden" asp-for="DisplayImageUrl" />
        <input type="hidden" asp-for="KMeans_K" />
        <input type="hidden" asp-for="PCAComponents" />
        <input type="hidden" asp-for="NumberOfFrames" />
        <input type="hidden" asp-for="OtsuImageUrl" />
        <input type="hidden" asp-for="KMeansImageUrl" />
        <input type="hidden" asp-for="PCAImageUrl" />
        <input type="hidden" asp-for="RegionGrowingImageUrl" />
        <input type="hidden" asp-for="WatershedImageUrl" />
        <button type="submit">Apply Watershed</button>
    </form>
  </div>
}

<!-- DICOM Metadata -->
@if (Model.Modality != null) 
{
  <div style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
      <h4>DICOM Metadata</h4>
      <p><strong>Patient:</strong> @Model.PatientName</p>
      <p><strong>Modality:</strong> @Model.Modality</p>
      @if (Model.NumberOfFrames > 1)
      {
        <p><strong>Frames:</strong> @Model.NumberOfFrames</p>
      }
  </div>
}